<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Tools</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
  <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #f8f8f8;
      --fg: #0a0a0a;
      --border: #e0e0e0;
      --hover: #eeeeee;
      --muted: #999999;
      --surface: #ffffff;
      --indicator: #0a0a0a;
    }

    [data-theme="dark"] {
      --bg: #0a0a0a;
      --fg: #f0f0f0;
      --border: #1f1f1f;
      --hover: #151515;
      --muted: #555555;
      --surface: #111111;
      --indicator: #f0f0f0;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      transition: background 0.5s cubic-bezier(0.4, 0, 0.2, 1), color 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: 1000;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 2rem;
      z-index: 100;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }

    .header-left {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .header-btn {
      background: none;
      border: none;
      color: var(--muted);
      padding: 0.5rem 0.75rem;
      font-size: 0.65rem;
      cursor: pointer;
      font-family: inherit;
      letter-spacing: 0.08em;
      transition: all 0.3s ease;
      text-transform: uppercase;
      font-weight: 600;
      position: relative;
    }

    .header-btn::after {
      content: '';
      position: absolute;
      bottom: 0.25rem;
      left: 0.75rem;
      right: 0.75rem;
      height: 1px;
      background: var(--fg);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .header-btn:hover {
      color: var(--fg);
    }

    .header-btn:hover::after {
      transform: scaleX(1);
    }

    .logo {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      text-decoration: none;
      color: var(--fg);
      text-transform: uppercase;
    }

    main {
      padding: 7rem 2rem 4rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .hero {
      margin-bottom: 3rem;
      text-align: center;
    }

    .hero-label {
      display: inline-block;
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 1.5rem;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
    }

    h1 {
      font-size: clamp(2rem, 6vw, 3rem);
      font-weight: 700;
      letter-spacing: -0.04em;
      line-height: 1.1;
      margin-bottom: 1rem;
    }

    h1 span {
      display: block;
      font-weight: 400;
      color: var(--muted);
      font-size: 0.4em;
      letter-spacing: 0;
      margin-top: 0.5rem;
    }

    /* Drop Zone - Initial */
    .drop-zone {
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 4rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 1.5rem;
    }

    .drop-zone.hidden {
      display: none;
    }

    .drop-zone::before {
      content: '';
      position: absolute;
      inset: -1px;
      border: 1px solid var(--fg);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }

    .drop-zone:hover::before,
    .drop-zone.drag-over::before {
      opacity: 1;
    }

    .drop-zone-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 1.5rem;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--muted);
    }

    .drop-zone:hover .drop-zone-icon {
      border-color: var(--fg);
      color: var(--fg);
      transform: translateY(-4px);
    }

    .drop-zone-text {
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      margin-bottom: 0.5rem;
    }

    .drop-zone-hint {
      font-size: 0.7rem;
      color: var(--muted);
    }

    #file-input {
      display: none;
    }

    /* Mini Drop Zone */
    .drop-zone-mini {
      display: none;
      border: 1px dashed var(--border);
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 0.5rem;
      background: var(--surface);
    }

    .drop-zone-mini.visible {
      display: block;
    }

    .drop-zone-mini:hover,
    .drop-zone-mini.drag-over {
      border-color: var(--fg);
      border-style: solid;
    }

    .drop-zone-mini-text {
      font-size: 0.7rem;
      color: var(--muted);
      font-weight: 500;
    }

    .drop-zone-mini:hover .drop-zone-mini-text {
      color: var(--fg);
    }

    /* Files List */
    .files-container {
      display: none;
    }

    .files-container.has-files {
      display: block;
      margin-bottom: 1.5rem;
    }

    .files-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding: 0 0.25rem;
    }

    .files-title {
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .files-count {
      font-size: 0.65rem;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }

    .files-list-wrapper {
      display: flex;
      position: relative;
    }

    .file-numbers {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
      pointer-events: none;
    }

    .file-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 3rem;
      background: var(--fg);
      color: var(--bg);
      font-size: 1.25rem;
      font-weight: 700;
      border: 1px solid var(--border);
      border-right: none;
    }

    #files-list {
      flex: 1;
      position: relative;
    }

    .file-group {
      background: var(--surface);
      border: 1px solid var(--border);
      margin-bottom: 0.375rem;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                  opacity 0.3s ease,
                  box-shadow 0.3s ease,
                  border-color 0.3s ease;
      position: relative;
    }

    .file-group:hover {
      border-color: var(--muted);
    }

    .file-group.dragging {
      opacity: 0.9;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      z-index: 100;
      border-color: var(--fg);
    }

    .file-group.drag-ghost {
      opacity: 0.3;
    }

    .file-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.875rem 1rem;
      cursor: grab;
      user-select: none;
      gap: 1rem;
    }

    .file-header:active {
      cursor: grabbing;
    }

    .file-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 0;
      flex: 1;
    }

    .file-index {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--muted);
    }

    .file-name {
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .file-meta {
      font-size: 0.6rem;
      color: var(--muted);
      white-space: nowrap;
      padding: 0.25rem 0.5rem;
      background: var(--hover);
    }

    .file-actions {
      display: flex;
      gap: 0.125rem;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--muted);
      width: 1.75rem;
      height: 1.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-btn:hover {
      color: var(--fg);
      background: var(--hover);
    }

    /* SortableJS styles */
    .sortable-ghost {
      opacity: 0.4;
    }

    .sortable-chosen {
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }

    .sortable-drag {
      opacity: 1 !important;
    }

    .file-group.sortable-ghost {
      opacity: 0.3;
    }

    .page-thumb.sortable-ghost {
      opacity: 0.3;
    }

    .page-thumb.sortable-chosen {
      border-color: var(--fg);
    }

    /* Pages Container */
    .pages-container {
      display: none;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    .pages-container.expanded {
      display: block;
    }

    .pages-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .pages-toolbar-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .select-all-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: none;
      border: 1px solid var(--border);
      padding: 0.4rem 0.7rem;
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .select-all-btn:hover {
      border-color: var(--fg);
      color: var(--fg);
    }

    .select-all-btn .checkbox {
      width: 12px;
      height: 12px;
      border: 1.5px solid currentColor;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .select-all-btn .checkbox .inner {
      width: 0;
      height: 0;
      background: var(--bg);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .select-all-btn.checked {
      border-color: var(--fg);
      color: var(--fg);
    }

    .select-all-btn.checked .checkbox {
      background: var(--fg);
      border-color: var(--fg);
    }

    .select-all-btn.checked .checkbox .inner {
      width: 5px;
      height: 5px;
      background: var(--bg);
    }

    .selection-count {
      font-size: 0.6rem;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }

    .selection-count.has-selection {
      color: var(--fg);
      font-weight: 600;
    }

    .pages-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 0.75rem;
      padding: 1rem;
      position: relative;
    }

    .page-thumb {
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      cursor: grab;
      transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                  border-color 0.2s ease,
                  box-shadow 0.25s ease,
                  opacity 0.2s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .page-thumb:hover {
      border-color: var(--muted);
    }

    .page-thumb.selected {
      border-color: var(--fg);
      border-width: 2px;
    }

    .page-thumb.dragging {
      opacity: 0.9;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      z-index: 100;
      border-color: var(--fg);
      transform: scale(1.05) rotate(2deg);
    }

    .page-thumb.drag-ghost {
      opacity: 0.3;
    }

    .page-thumb-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3rem 0.4rem;
      background: var(--hover);
      border-bottom: 1px solid var(--border);
    }

    .page-checkbox {
      width: 14px;
      height: 14px;
      border: 1.5px solid var(--border);
      background: var(--surface);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .page-checkbox .inner {
      width: 0;
      height: 0;
      background: var(--bg);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .page-checkbox:hover {
      border-color: var(--fg);
    }

    .page-thumb.selected .page-checkbox {
      background: var(--fg);
      border-color: var(--fg);
    }

    .page-thumb.selected .page-checkbox .inner {
      width: 6px;
      height: 6px;
      background: var(--bg);
    }

    .page-global-num {
      font-size: 0.55rem;
      font-weight: 600;
      color: var(--fg);
      font-variant-numeric: tabular-nums;
    }

    .page-canvas-wrap {
      aspect-ratio: 3/4;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      overflow: hidden;
    }

    .page-canvas-wrap canvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .page-thumb-footer {
      padding: 0.35rem 0.4rem;
      background: var(--fg);
      color: var(--bg);
      text-align: center;
    }

    .page-original-info {
      font-size: 0.5rem;
      font-weight: 500;
      opacity: 0.9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--fg);
      color: var(--bg);
      padding: 0.4rem 0.6rem;
      font-size: 0.55rem;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 10;
      pointer-events: none;
    }

    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 4px solid transparent;
      border-top-color: var(--fg);
    }

    .page-thumb:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    .page-thumb.dragging .tooltip {
      opacity: 0;
      visibility: hidden;
    }

    /* Options */
    .options {
      display: none;
      background: var(--surface);
      border: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }

    .options.visible {
      display: block;
    }

    .options-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.55rem;
      font-weight: 600;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .options-body {
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .options-group {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .options-group-label {
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--muted);
      min-width: 3rem;
    }

    .options-group-items {
      display: flex;
      gap: 0.75rem;
    }

    .option-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      padding: 0.25rem 0;
    }

    .option-radio,
    .option-checkbox {
      width: 14px;
      height: 14px;
      border: 1.5px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      flex-shrink: 0;
    }

    .option-radio {
      border-radius: 50%;
    }

    .option-radio .inner,
    .option-checkbox .inner {
      width: 0;
      height: 0;
      background: var(--bg);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .option-radio .inner {
      border-radius: 50%;
    }

    .option-item:hover .option-radio,
    .option-item:hover .option-checkbox {
      border-color: var(--fg);
    }

    .option-radio.checked,
    .option-checkbox.checked {
      background: var(--fg);
      border-color: var(--fg);
    }

    .option-radio.checked .inner,
    .option-checkbox.checked .inner {
      width: 6px;
      height: 6px;
      background: var(--bg);
    }

    .option-label {
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--muted);
      transition: color 0.2s ease;
    }

    .option-item:hover .option-label {
      color: var(--fg);
    }

    .option-item.active .option-label {
      color: var(--fg);
    }

    .options-divider {
      width: 1px;
      height: 2rem;
      background: var(--border);
    }

    /* Actions */
    .actions {
      display: none;
      gap: 0.5rem;
    }

    .actions.visible {
      display: flex;
    }

    .btn-primary {
      flex: 1;
      padding: 1rem 2rem;
      background: var(--fg);
      color: var(--bg);
      border: none;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: var(--bg);
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary:hover::before {
      transform: translateY(0);
    }

    .btn-primary span {
      position: relative;
      z-index: 1;
      transition: color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-primary:hover span {
      color: var(--fg);
    }

    .btn-primary:hover {
      border: 1px solid var(--fg);
    }

    .btn-secondary {
      padding: 1rem 1.25rem;
      background: none;
      color: var(--muted);
      border: 1px solid var(--border);
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      text-transform: uppercase;
    }

    .btn-secondary:hover {
      border-color: var(--fg);
      color: var(--fg);
    }

    /* Loading */
    .loading {
      display: none;
      text-align: center;
      padding: 3rem;
    }

    .loading.visible {
      display: block;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 1.5px solid var(--border);
      border-top-color: var(--fg);
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    /* Footer */
    footer {
      text-align: center;
      padding: 4rem 2rem;
    }

    footer a {
      font-size: 0.55rem;
      font-weight: 600;
      color: var(--muted);
      text-decoration: none;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      transition: color 0.3s ease;
    }

    footer a:hover {
      color: var(--fg);
    }

    /* Responsive */
    @media (max-width: 600px) {
      header {
        padding: 1rem 1.25rem;
      }

      main {
        padding: 5.5rem 1.25rem 2rem;
      }

      .drop-zone {
        padding: 3rem 1.5rem;
      }

      .options.visible {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
      }

      .options-divider {
        display: none;
      }

      .pages-grid {
        grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
        gap: 0.5rem;
      }
    }

    ::selection {
      background: var(--fg);
      color: var(--bg);
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="header-left">
      <button class="header-btn" id="lang-toggle">JP</button>
      <button class="header-btn" id="theme-toggle">Dark</button>
    </div>
    <a href="https://mamonis.studio/" class="logo">Mamonis</a>
  </header>

  <main>
    <div class="hero">
      <div class="hero-label">Browser-based Tool</div>
      <h1>
        PDF Tools
        <span data-i18n="subtitle">No upload. No server. Just works.</span>
      </h1>
    </div>

    <div class="drop-zone" id="drop-zone">
      <div class="drop-zone-icon">+</div>
      <div class="drop-zone-text" data-i18n="dropText">Add PDF or Images</div>
      <div class="drop-zone-hint" data-i18n="dropHint">Drop here or click to browse</div>
    </div>
    <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp" multiple>

    <div class="files-container" id="files-container">
      <div class="files-header">
        <span class="files-title" data-i18n="filesTitle">Files</span>
        <span class="files-count" id="files-count"></span>
      </div>
      <div class="files-list-wrapper">
        <div class="file-numbers" id="file-numbers"></div>
        <div id="files-list"></div>
      </div>
      
      <div class="drop-zone-mini" id="drop-zone-mini">
        <span class="drop-zone-mini-text" data-i18n="addMore">+ Add more files</span>
      </div>
    </div>

    <div class="options" id="options">
      <div class="options-header" data-i18n="outputHeader">Output</div>
      <div class="options-body">
        <div class="options-group">
          <span class="options-group-label" data-i18n="targetLabel">Target</span>
          <div class="options-group-items">
            <div class="option-item active" data-option="targetAll" data-group="target">
              <div class="option-radio checked"><div class="inner"></div></div>
              <span class="option-label" data-i18n="targetAll">All</span>
            </div>
            <div class="option-item" data-option="targetSelected" data-group="target">
              <div class="option-radio"><div class="inner"></div></div>
              <span class="option-label" data-i18n="targetSelected">Selected</span>
            </div>
          </div>
        </div>
        
        <div class="options-divider"></div>
        
        <div class="options-group">
          <span class="options-group-label" data-i18n="methodLabel">Method</span>
          <div class="options-group-items">
            <div class="option-item active" data-option="merge" data-group="method">
              <div class="option-radio checked"><div class="inner"></div></div>
              <span class="option-label" data-i18n="optMerge">Merge</span>
            </div>
            <div class="option-item" data-option="split" data-group="method">
              <div class="option-radio"><div class="inner"></div></div>
              <span class="option-label" data-i18n="optSplit">Split</span>
            </div>
          </div>
        </div>
        
        <div class="options-divider"></div>
        
        <div class="options-group">
          <span class="options-group-label" data-i18n="optionLabel">Option</span>
          <div class="options-group-items">
            <div class="option-item" data-option="compress" data-group="option">
              <div class="option-checkbox"><div class="inner"></div></div>
              <span class="option-label" data-i18n="optCompress">Compress</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text" data-i18n="processing">Processing</div>
    </div>

    <div class="actions" id="actions">
      <button class="btn-secondary" id="btn-clear" data-i18n="clear">Clear</button>
      <button class="btn-primary" id="btn-download"><span data-i18n="download">Download</span></button>
    </div>
  </main>

  <footer>
    <a href="https://mamonis.studio/">© 2026 Mamonis</a>
  </footer>

  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

    const i18n = {
      en: {
        subtitle: 'No upload. No server. Just works.',
        dropText: 'Add PDF or Images',
        dropHint: 'Drop here or click to browse',
        addMore: '+ Add more files',
        filesTitle: 'Files',
        outputHeader: 'Output',
        targetLabel: 'Target',
        targetAll: 'All',
        targetSelected: 'Selected',
        methodLabel: 'Method',
        optMerge: 'Merge',
        optSplit: 'Split',
        optionLabel: 'Option',
        optCompress: 'Compress',
        processing: 'Processing',
        clear: 'Clear',
        download: 'Download',
        pages: 'p',
        totalPages: 'pages total',
        selectAll: 'All',
        selected: 'selected'
      },
      ja: {
        subtitle: 'アップロード不要。サーバー不要。',
        dropText: 'PDF・画像を追加',
        dropHint: 'ドロップまたはクリック',
        addMore: '+ ファイルを追加',
        filesTitle: 'ファイル',
        outputHeader: '出力',
        targetLabel: '対象',
        targetAll: '全て',
        targetSelected: '選択のみ',
        methodLabel: '方法',
        optMerge: '結合',
        optSplit: '分割',
        optionLabel: 'オプション',
        optCompress: '圧縮',
        processing: '処理中',
        clear: 'クリア',
        download: 'ダウンロード',
        pages: 'p',
        totalPages: 'ページ',
        selectAll: '全選択',
        selected: '選択中'
      }
    };

    let currentLang = navigator.language.startsWith('ja') ? 'ja' : 'en';
    let pdfFiles = [];
    let globalPageIndex = 0;
    const options = { targetAll: true, targetSelected: false, merge: true, split: false, compress: false };

    // Sortable instances
    let fileSortable = null;
    let pageSortables = [];

    const dropZone = document.getElementById('drop-zone');
    const dropZoneMini = document.getElementById('drop-zone-mini');
    const fileInput = document.getElementById('file-input');
    const filesContainer = document.getElementById('files-container');
    const filesList = document.getElementById('files-list');
    const optionsEl = document.getElementById('options');
    const actionsEl = document.getElementById('actions');
    const loadingEl = document.getElementById('loading');

    function updateLanguage() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (i18n[currentLang][key]) {
          el.textContent = i18n[currentLang][key];
        }
      });
      document.getElementById('lang-toggle').textContent = currentLang === 'en' ? 'JP' : 'EN';
      updateFilesCount();
    }

    document.getElementById('theme-toggle').addEventListener('click', function() {
      const isDark = document.body.dataset.theme === 'dark';
      document.body.dataset.theme = isDark ? 'light' : 'dark';
      this.textContent = isDark ? 'Dark' : 'Light';
    });

    document.getElementById('lang-toggle').addEventListener('click', () => {
      currentLang = currentLang === 'en' ? 'ja' : 'en';
      updateLanguage();
      renderFiles();
    });

    // Drop zones
    [dropZone, dropZoneMini].forEach(zone => {
      zone.addEventListener('click', () => fileInput.click());
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('drag-over');
      });
      zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
      zone.addEventListener('drop', async (e) => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files).filter(f => f.type === 'application/pdf');
        if (files.length) await addFiles(files);
      });
    });

    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files);
      if (files.length) await addFiles(files);
      fileInput.value = '';
    });

    // 画像をPDFに変換する関数
    async function imageToPdfData(file) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = async () => {
          const { PDFDocument } = PDFLib;
          const pdfDoc = await PDFDocument.create();
          
          // A4サイズ（72dpi基準）
          const pageWidth = 595;
          const pageHeight = 842;
          
          // 画像のアスペクト比を保持してフィット
          const imgRatio = img.width / img.height;
          const pageRatio = pageWidth / pageHeight;
          
          let drawWidth, drawHeight;
          if (imgRatio > pageRatio) {
            drawWidth = pageWidth - 40;
            drawHeight = drawWidth / imgRatio;
          } else {
            drawHeight = pageHeight - 40;
            drawWidth = drawHeight * imgRatio;
          }
          
          const page = pdfDoc.addPage([pageWidth, pageHeight]);
          
          // 画像を埋め込む
          const arrayBuffer = await file.arrayBuffer();
          let embeddedImg;
          const type = file.type;
          if (type === 'image/png') {
            embeddedImg = await pdfDoc.embedPng(arrayBuffer);
          } else {
            embeddedImg = await pdfDoc.embedJpg(arrayBuffer);
          }
          
          const x = (pageWidth - drawWidth) / 2;
          const y = (pageHeight - drawHeight) / 2;
          
          page.drawImage(embeddedImg, {
            x, y,
            width: drawWidth,
            height: drawHeight
          });
          
          const pdfBytes = await pdfDoc.save();
          resolve(pdfBytes);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    async function addFiles(files) {
      loadingEl.classList.add('visible');
      
      for (const file of files) {
        const fileNum = pdfFiles.length + 1;
        let dataToStore;
        let pdfDoc;
        let pageCount;
        
        const isImage = file.type.startsWith('image/');
        
        if (isImage) {
          // 画像をPDFに変換
          const pdfBytes = await imageToPdfData(file);
          // Uint8Arrayをコピーして保持
          dataToStore = new Uint8Array(pdfBytes);
          pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes.slice() }).promise;
          pageCount = 1;
        } else {
          // PDFをそのまま処理
          const originalBuffer = await file.arrayBuffer();
          // ArrayBufferをコピーして保持（pdfjs-distがdetachするので）
          dataToStore = new Uint8Array(originalBuffer.slice(0));
          pdfDoc = await pdfjsLib.getDocument({ data: originalBuffer }).promise;
          pageCount = pdfDoc.numPages;
        }
        
        const pages = [];
        for (let i = 1; i <= pageCount; i++) {
          globalPageIndex++;
          pages.push({
            pageNum: i,
            globalIndex: globalPageIndex,
            originalFile: file.name,
            originalFileIndex: fileNum,
            originalPageNum: i,
            originalTotalPages: pageCount,
            originalData: dataToStore,
            selected: false,
            thumbnail: null
          });
        }
        
        pdfFiles.push({
          id: Date.now() + Math.random(),
          name: file.name,
          originalIndex: fileNum,
          data: dataToStore,
          pdfDoc,
          pages,
          expanded: false
        });
      }
      
      renderFiles();
      updateUI();
      loadingEl.classList.remove('visible');
    }

    function updateFilesCount() {
      const totalPages = pdfFiles.reduce((sum, f) => sum + f.pages.length, 0);
      const countEl = document.getElementById('files-count');
      if (pdfFiles.length > 0) {
        countEl.textContent = `${pdfFiles.length} files · ${totalPages} ${i18n[currentLang].totalPages}`;
      } else {
        countEl.textContent = '';
      }
    }

    function getSelectedCount(file) {
      return file.pages.filter(p => p.selected).length;
    }

    function getTotalSelectedCount() {
      return pdfFiles.reduce((sum, f) => sum + getSelectedCount(f), 0);
    }

    function renderFiles() {
      filesList.innerHTML = '';
      const fileNumbers = document.getElementById('file-numbers');
      fileNumbers.innerHTML = '';
      updateFilesCount();
      
      // 丸数字を生成する関数
      const getCircledNumber = (n) => {
        if (n <= 20) return String.fromCharCode(0x2460 + n - 1); // ①〜⑳
        return `(${n})`; // 21以上は(21)形式
      };
      
      pdfFiles.forEach((file, fileIndex) => {
        // 番号を別コンテナに追加
        const numberEl = document.createElement('div');
        numberEl.className = 'file-number';
        numberEl.dataset.fileIndex = fileIndex;
        fileNumbers.appendChild(numberEl);
        
        const group = document.createElement('div');
        group.className = 'file-group';
        group.dataset.fileIndex = fileIndex;
        
        const selectedCount = getSelectedCount(file);
        const allSelected = selectedCount === file.pages.length && file.pages.length > 0;
        const circledNum = getCircledNumber(file.originalIndex || fileIndex + 1);
        
        group.innerHTML = `
          <div class="file-header">
            <div class="file-info">
              <span class="file-index">${circledNum}</span>
              <span class="file-name">${file.name}</span>
              <span class="file-meta">${file.pages.length}${i18n[currentLang].pages}</span>
            </div>
            <div class="file-actions">
              <button class="icon-btn expand-btn">${file.expanded ? '↑' : '↓'}</button>
              <button class="icon-btn remove-btn">×</button>
            </div>
          </div>
          <div class="pages-container ${file.expanded ? 'expanded' : ''}">
            <div class="pages-toolbar">
              <div class="pages-toolbar-left">
                <button class="select-all-btn ${allSelected ? 'checked' : ''}" data-file-index="${fileIndex}">
                  <span class="checkbox"><span class="inner"></span></span>
                  <span>${i18n[currentLang].selectAll}</span>
                </button>
                <span class="selection-count ${selectedCount > 0 ? 'has-selection' : ''}">${selectedCount}/${file.pages.length} ${i18n[currentLang].selected}</span>
              </div>
            </div>
            <div class="pages-grid" data-file-index="${fileIndex}"></div>
          </div>
        `;
        
        group.querySelector('.expand-btn').addEventListener('click', async () => {
          file.expanded = !file.expanded;
          if (file.expanded) await generateThumbnails(file);
          renderFiles();
          // サムネイル読み込み後に高さを再更新
          setTimeout(updateFileNumberHeights, 100);
        });
        
        group.querySelector('.remove-btn').addEventListener('click', () => {
          pdfFiles = pdfFiles.filter(f => f.id !== file.id);
          recalculateGlobalIndex();
          renderFiles();
          updateUI();
        });

        // Select all button
        const selectAllBtn = group.querySelector('.select-all-btn');
        if (selectAllBtn) {
          selectAllBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const allCurrentlySelected = file.pages.every(p => p.selected);
            file.pages.forEach(p => p.selected = !allCurrentlySelected);
            renderFiles();
          });
        }
        
        // Pages
        if (file.expanded) {
          const pagesGrid = group.querySelector('.pages-grid');
          file.pages.forEach((page, pageIndex) => {
            const thumb = document.createElement('div');
            thumb.className = `page-thumb ${page.selected ? 'selected' : ''}`;
            thumb.dataset.fileIndex = fileIndex;
            thumb.dataset.pageIndex = pageIndex;
            
            const shortFileName = page.originalFile.length > 12 
              ? page.originalFile.substring(0, 10) + '...' 
              : page.originalFile;
            
            const origFileCircled = getCircledNumber(page.originalFileIndex);
            
            thumb.innerHTML = `
              <div class="tooltip">${page.originalFile}</div>
              <div class="page-thumb-header">
                <div class="page-checkbox"><div class="inner"></div></div>
                <span class="page-global-num">#${page.globalIndex}</span>
              </div>
              <div class="page-canvas-wrap"></div>
              <div class="page-thumb-footer">
                <div class="page-original-info">${origFileCircled}-${page.originalPageNum}/${page.originalTotalPages}</div>
              </div>
            `;
            
            if (page.thumbnail) {
              const canvasWrap = thumb.querySelector('.page-canvas-wrap');
              const canvas = page.thumbnail.cloneNode();
              canvas.getContext('2d').drawImage(page.thumbnail, 0, 0);
              canvasWrap.appendChild(canvas);
            }
            
            // Checkbox click
            thumb.querySelector('.page-checkbox').addEventListener('click', (e) => {
              e.stopPropagation();
              page.selected = !page.selected;
              renderFiles();
            });
            
            pagesGrid.appendChild(thumb);
          });
        }
        
        filesList.appendChild(group);
      });
      
      // Initialize SortableJS
      initSortables();
      
      // 番号の高さを同期（DOM描画後に実行）
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          updateFileNumberHeights();
        });
      });
    }

    function updateFileNumberHeights() {
      const fileGroups = document.querySelectorAll('.file-group');
      const fileNumbers = document.querySelectorAll('.file-number');
      
      fileGroups.forEach((group, i) => {
        if (fileNumbers[i]) {
          const height = group.offsetHeight;
          fileNumbers[i].style.height = height + 'px';
          fileNumbers[i].textContent = i + 1;
        }
      });
    }

    // ========== SORTABLE SYSTEM ==========
    
    function initSortables() {
      // Destroy existing sortables
      if (fileSortable) {
        fileSortable.destroy();
        fileSortable = null;
      }
      pageSortables.forEach(s => s.destroy());
      pageSortables = [];
      
      // File list sortable
      if (filesList.children.length > 0) {
        fileSortable = new Sortable(filesList, {
          animation: 200,
          handle: '.file-header',
          ghostClass: 'sortable-ghost',
          chosenClass: 'sortable-chosen',
          dragClass: 'sortable-drag',
          onEnd: (evt) => {
            const oldIndex = evt.oldIndex;
            const newIndex = evt.newIndex;
            if (oldIndex !== newIndex) {
              const [moved] = pdfFiles.splice(oldIndex, 1);
              pdfFiles.splice(newIndex, 0, moved);
              recalculateGlobalIndex();
              renderFiles();
            }
          }
        });
      }
      
      // Page grids sortable
      document.querySelectorAll('.pages-grid').forEach(grid => {
        const fileIndex = parseInt(grid.dataset.fileIndex);
        const sortable = new Sortable(grid, {
          animation: 200,
          group: 'pages',
          ghostClass: 'sortable-ghost',
          chosenClass: 'sortable-chosen',
          dragClass: 'sortable-drag',
          filter: '.page-checkbox',
          onEnd: (evt) => {
            const fromFileIndex = parseInt(evt.from.dataset.fileIndex);
            const toFileIndex = parseInt(evt.to.dataset.fileIndex);
            const oldIndex = evt.oldIndex;
            const newIndex = evt.newIndex;
            
            if (fromFileIndex === toFileIndex && oldIndex === newIndex) return;
            
            const [movedPage] = pdfFiles[fromFileIndex].pages.splice(oldIndex, 1);
            pdfFiles[toFileIndex].pages.splice(newIndex, 0, movedPage);
            
            if (pdfFiles[fromFileIndex].pages.length === 0) {
              pdfFiles.splice(fromFileIndex, 1);
            }
            
            recalculateGlobalIndex();
            renderFiles();
            updateUI();
          }
        });
        pageSortables.push(sortable);
      });
    }

    async function generateThumbnails(file) {
      for (const page of file.pages) {
        if (!page.thumbnail) {
          try {
            const pdfPage = await file.pdfDoc.getPage(page.originalPageNum);
            const viewport = pdfPage.getViewport({ scale: 0.3 });
            
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            
            await pdfPage.render({
              canvasContext: canvas.getContext('2d'),
              viewport
            }).promise;
            
            page.thumbnail = canvas;
          } catch (err) {
            console.error('Thumbnail error:', err);
          }
        }
      }
    }

    function recalculateGlobalIndex() {
      let idx = 0;
      pdfFiles.forEach(file => {
        file.pages.forEach(page => {
          idx++;
          page.globalIndex = idx;
        });
      });
      globalPageIndex = idx;
    }

    function updateUI() {
      const hasFiles = pdfFiles.length > 0;
      filesContainer.classList.toggle('has-files', hasFiles);
      dropZone.classList.toggle('hidden', hasFiles);
      dropZoneMini.classList.toggle('visible', hasFiles);
      optionsEl.classList.toggle('visible', hasFiles);
      actionsEl.classList.toggle('visible', hasFiles);
      updateFilesCount();
    }

    // Options
    document.querySelectorAll('.option-item').forEach(item => {
      item.addEventListener('click', () => {
        const option = item.dataset.option;
        const group = item.dataset.group;
        
        if (group === 'target') {
          // Radio style
          options.targetAll = option === 'targetAll';
          options.targetSelected = option === 'targetSelected';
          
          document.querySelectorAll('.option-item[data-group="target"]').forEach(i => {
            const opt = i.dataset.option;
            const radio = i.querySelector('.option-radio');
            const isChecked = options[opt];
            radio.classList.toggle('checked', isChecked);
            i.classList.toggle('active', isChecked);
          });
        } else if (group === 'method') {
          // Radio style
          options.merge = option === 'merge';
          options.split = option === 'split';
          
          document.querySelectorAll('.option-item[data-group="method"]').forEach(i => {
            const opt = i.dataset.option;
            const radio = i.querySelector('.option-radio');
            const isChecked = options[opt];
            radio.classList.toggle('checked', isChecked);
            i.classList.toggle('active', isChecked);
          });
        } else if (group === 'option') {
          // Checkbox style
          options[option] = !options[option];
          const checkbox = item.querySelector('.option-checkbox');
          checkbox.classList.toggle('checked');
          item.classList.toggle('active', options[option]);
        }
      });
    });

    document.getElementById('btn-clear').addEventListener('click', () => {
      pdfFiles = [];
      globalPageIndex = 0;
      renderFiles();
      updateUI();
    });

    document.getElementById('btn-download').addEventListener('click', async () => {
      if (pdfFiles.length === 0) return;
      
      loadingEl.classList.add('visible');
      actionsEl.classList.remove('visible');
      
      try {
        const { PDFDocument } = PDFLib;
        
        // Collect pages to export based on target option
        const pagesToExport = [];
        
        for (const file of pdfFiles) {
          for (const page of file.pages) {
            if (options.targetAll || (options.targetSelected && page.selected)) {
              pagesToExport.push({
                data: page.originalData,
                pageNum: page.originalPageNum,
                fileName: page.originalFile,
                globalIndex: page.globalIndex
              });
            }
          }
        }
        
        if (pagesToExport.length === 0) {
          alert(currentLang === 'ja' ? 'ページが選択されていません' : 'No pages selected');
          loadingEl.classList.remove('visible');
          actionsEl.classList.add('visible');
          return;
        }
        
        if (options.split) {
          // Split mode - create ZIP
          const zip = new JSZip();
          
          for (let i = 0; i < pagesToExport.length; i++) {
            const p = pagesToExport[i];
            const srcDoc = await PDFDocument.load(p.data);
            const newDoc = await PDFDocument.create();
            const [copiedPage] = await newDoc.copyPages(srcDoc, [p.pageNum - 1]);
            newDoc.addPage(copiedPage);
            
            // 圧縮オプション
            const saveOptions = options.compress ? { useObjectStreams: true } : {};
            const pdfBytes = await newDoc.save(saveOptions);
            zip.file(`page_${String(i + 1).padStart(3, '0')}.pdf`, pdfBytes);
          }
          
          const timestamp = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
          // ZIP圧縮レベルを設定
          const zipOptions = options.compress 
            ? { type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 9 } }
            : { type: 'blob' };
          const zipBlob = await zip.generateAsync(zipOptions);
          const url = URL.createObjectURL(zipBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `mamonis_pdf_${timestamp}.zip`;
          a.click();
          URL.revokeObjectURL(url);
          
        } else {
          // Merge mode
          const mergedPdf = await PDFDocument.create();
          
          for (const p of pagesToExport) {
            const srcDoc = await PDFDocument.load(p.data);
            const [copiedPage] = await mergedPdf.copyPages(srcDoc, [p.pageNum - 1]);
            mergedPdf.addPage(copiedPage);
          }
          
          // 圧縮オプション
          const saveOptions = options.compress ? { useObjectStreams: true } : {};
          const pdfBytes = await mergedPdf.save(saveOptions);
          
          const timestamp = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
          const blob = new Blob([pdfBytes], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `mamonis_pdf_${timestamp}.pdf`;
          a.click();
          URL.revokeObjectURL(url);
        }
        
      } catch (err) {
        console.error(err);
        alert('Error processing PDF');
      }
      
      loadingEl.classList.remove('visible');
      actionsEl.classList.add('visible');
    });

    updateLanguage();
  </script>
</body>
</html>
